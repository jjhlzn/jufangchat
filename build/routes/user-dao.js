"use strict";
var db = require('../db/index');
var client = db.get_redis_client();
function find_user_by_mobile(mobile, callback) {
    var userid = mobile;
    client.get("nodejs_userinfo_" + userid, function (err, reply) {
        if (reply != null) {
            //console.log("user in redis: " + reply);
            callback(JSON.parse(reply));
            return;
        }
        var makeUserJson = function (row) {
            return {
                NickName: row['NickName'],
                CanChat: row['CanChat'],
                Mobile: row['Mobile'],
                CustName: row['CustName'],
                ManagerFlg: row['ManagerFlg'],
                PCustCd: row['PCustCd'],
                ParentMobile: row['ParentMobile']
            };
        };
        db.get_connection().then(function () {
            var request = db.get_request();
            request.stream = true;
            request.query("select *, (select Mobile from BasCust b where a.PCustCd = b.CustCd) as ParentMobile  from BasCust a where mobile = '"
                + userid + "'");
            request.on('row', function (row) {
                //将昵称和是否能发言放到redis中
                var nickName = row['NickName'];
                var canChat = row['CanChat'];
                if (nickName == null || nickName == undefined) {
                    nickName = '匿名';
                }
                row['NickName'] = nickName;
                if (canChat == null || canChat == undefined) {
                    canChat = true;
                }
                else if (canChat == 0) {
                    canChat = true;
                }
                else if (canChat == 1) {
                    canChat = false;
                }
                row['CanChat'] = canChat;
                var isManager = row['ManagerFlg'];
                if (isManager == null || isManager == undefined) {
                    isManager = false;
                }
                if (isManager == 1 || isManager == true) {
                    isManager = true;
                }
                else {
                    isManager = false;
                }
                row['ManagerFlg'] = isManager;
                console.log('ManagerFlg = ' + row['ManagerFlg']);
                //console.log(row);
                var userJson = makeUserJson(row);
                client.set("nodejs_userinfo_" + userid, JSON.stringify(userJson));
                callback(userJson);
            });
        }).catch(function (err) {
            console.log(err);
        });
    });
}
exports.find_user_by_mobile = find_user_by_mobile;
/**
 * 将用户放放到各个房间中。
 */
var LiveUserManager = (function () {
    function LiveUserManager() {
        this.client = db.get_redis_client();
    }
    LiveUserManager.prototype.userJoinRoom = function (socket, songId) {
        //将用户信息加入到redis中
    };
    LiveUserManager.prototype.userLeaveRoom = function (socket, songId) {
        //将用户信息从redis中移除
    };
    LiveUserManager.prototype.getRoomUserCount = function (songId) {
        //统计redis中的记录条数
        return 0;
    };
    LiveUserManager.prototype.getUserInfo = function (socket) {
        //使用socket.id，获取用户信息
    };
    LiveUserManager.prototype.getUsers = function (songId) {
        //用户房间的所有用户
    };
    LiveUserManager.prototype.getAllUserMobile = function () {
        return new Set();
    };
    LiveUserManager.prototype.setChat = function (songId, userMobile, canChat) {
        //设置用户是否禁言
    };
    return LiveUserManager;
}());
exports.LiveUserManager = LiveUserManager;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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TUFBTTtRQUNkLG9CQUFvQjtJQUN4QixDQUFDO0lBRUQsa0NBQVEsR0FBUixVQUFTLE1BQU07UUFDWCxXQUFXO0lBQ2YsQ0FBQztJQUVELDBDQUFnQixHQUFoQjtRQUNJLE1BQU0sQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxpQ0FBTyxHQUFQLFVBQVEsTUFBTSxFQUFFLFVBQVUsRUFBRSxPQUFPO1FBQy9CLFVBQVU7SUFDZCxDQUFDO0lBRUwsc0JBQUM7QUFBRCxDQXJDQSxBQXFDQyxJQUFBO0FBckNZLHVCQUFlLGtCQXFDM0IsQ0FBQSIsImZpbGUiOiJyb3V0ZXMvdXNlci1kYW8uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkYiBmcm9tICcuLi9kYi9pbmRleCc7XG5jb25zdCBjbGllbnQgPSAgZGIuZ2V0X3JlZGlzX2NsaWVudCgpO1xuXG5leHBvcnQgZnVuY3Rpb24gZmluZF91c2VyX2J5X21vYmlsZShtb2JpbGUsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHVzZXJpZCA9IG1vYmlsZTtcbiAgICBjbGllbnQuZ2V0KFwibm9kZWpzX3VzZXJpbmZvX1wiK3VzZXJpZCwgZnVuY3Rpb24oZXJyLCByZXBseSl7XG4gICAgICAgIFxuICAgICAgICBpZiAocmVwbHkgIT0gbnVsbCkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcInVzZXIgaW4gcmVkaXM6IFwiICsgcmVwbHkpO1xuICAgICAgICAgICAgY2FsbGJhY2soSlNPTi5wYXJzZShyZXBseSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIG1ha2VVc2VySnNvbiA9IGZ1bmN0aW9uKHJvdykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBOaWNrTmFtZTogcm93WydOaWNrTmFtZSddLCBcbiAgICAgICAgICAgICAgICBDYW5DaGF0OiByb3dbJ0NhbkNoYXQnXSxcbiAgICAgICAgICAgICAgICBNb2JpbGU6IHJvd1snTW9iaWxlJ10sXG4gICAgICAgICAgICAgICAgQ3VzdE5hbWU6IHJvd1snQ3VzdE5hbWUnXSxcbiAgICAgICAgICAgICAgICBNYW5hZ2VyRmxnOiByb3dbJ01hbmFnZXJGbGcnXSxcbiAgICAgICAgICAgICAgICBQQ3VzdENkOiByb3dbJ1BDdXN0Q2QnXSxcbiAgICAgICAgICAgICAgICBQYXJlbnRNb2JpbGU6IHJvd1snUGFyZW50TW9iaWxlJ11cbiAgICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBkYi5nZXRfY29ubmVjdGlvbigpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB2YXIgcmVxdWVzdCA9IGRiLmdldF9yZXF1ZXN0KCk7XG4gICAgICAgICAgICByZXF1ZXN0LnN0cmVhbSA9IHRydWU7XG4gICAgICAgICAgICByZXF1ZXN0LnF1ZXJ5KFwic2VsZWN0ICosIChzZWxlY3QgTW9iaWxlIGZyb20gQmFzQ3VzdCBiIHdoZXJlIGEuUEN1c3RDZCA9IGIuQ3VzdENkKSBhcyBQYXJlbnRNb2JpbGUgIGZyb20gQmFzQ3VzdCBhIHdoZXJlIG1vYmlsZSA9ICdcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICArIHVzZXJpZCArIFwiJ1wiKTtcbiAgICAgICAgICAgIHJlcXVlc3Qub24oJ3JvdycsIGZ1bmN0aW9uKHJvdyl7XG4gICAgICAgICAgICAgICAgLy/lsIbmmLXnp7DlkozmmK/lkKbog73lj5HoqIDmlL7liLByZWRpc+S4rVxuICAgICAgICAgICAgICAgIHZhciBuaWNrTmFtZSA9IHJvd1snTmlja05hbWUnXTtcbiAgICAgICAgICAgICAgICB2YXIgY2FuQ2hhdCA9IHJvd1snQ2FuQ2hhdCddO1xuICAgICAgICAgICAgICAgIGlmIChuaWNrTmFtZSA9PSBudWxsIHx8IG5pY2tOYW1lID09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgICAgIG5pY2tOYW1lID0gJ+WMv+WQjSc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJvd1snTmlja05hbWUnXSA9IG5pY2tOYW1lO1xuICAgICAgICAgICAgICAgIGlmIChjYW5DaGF0ID09IG51bGwgfHwgY2FuQ2hhdCA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FuQ2hhdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYW5DaGF0ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2FuQ2hhdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYW5DaGF0ID09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FuQ2hhdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByb3dbJ0NhbkNoYXQnXSA9IGNhbkNoYXQ7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGlzTWFuYWdlciA9IHJvd1snTWFuYWdlckZsZyddO1xuICAgICAgICAgICAgICAgIGlmIChpc01hbmFnZXIgPT0gbnVsbCB8fCBpc01hbmFnZXIgPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTWFuYWdlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaXNNYW5hZ2VyID09IDEgfHwgaXNNYW5hZ2VyID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNNYW5hZ2VyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpc01hbmFnZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcm93WydNYW5hZ2VyRmxnJ10gPSBpc01hbmFnZXI7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01hbmFnZXJGbGcgPSAnICsgcm93WydNYW5hZ2VyRmxnJ10pO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2cocm93KTtcbiAgICAgICAgICAgICAgICB2YXIgdXNlckpzb24gPSBtYWtlVXNlckpzb24ocm93KTtcbiAgICAgICAgICAgICAgICBjbGllbnQuc2V0KFwibm9kZWpzX3VzZXJpbmZvX1wiK3VzZXJpZCwgSlNPTi5zdHJpbmdpZnkodXNlckpzb24pKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayh1c2VySnNvbik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICB9KTsgXG4gICAgfSk7XG59XG5cbi8qKlxuICog5bCG55So5oi35pS+5pS+5Yiw5ZCE5Liq5oi/6Ze05Lit44CCXG4gKi9cbmV4cG9ydCBjbGFzcyBMaXZlVXNlck1hbmFnZXIge1xuXG4gICAgY2xpZW50OiBhbnlcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLmNsaWVudCA9ICBkYi5nZXRfcmVkaXNfY2xpZW50KCk7XG4gICAgfVxuXG4gICAgdXNlckpvaW5Sb29tKHNvY2tldCwgc29uZ0lkKSB7XG4gICAgICAgIC8v5bCG55So5oi35L+h5oGv5Yqg5YWl5YiwcmVkaXPkuK1cbiAgICB9XG5cbiAgICB1c2VyTGVhdmVSb29tKHNvY2tldCwgc29uZ0lkKSB7XG4gICAgICAgIC8v5bCG55So5oi35L+h5oGv5LuOcmVkaXPkuK3np7vpmaRcbiAgICB9XG5cbiAgICBnZXRSb29tVXNlckNvdW50KHNvbmdJZCkge1xuICAgICAgICAvL+e7n+iuoXJlZGlz5Lit55qE6K6w5b2V5p2h5pWwXG4gICAgICAgIHJldHVybiAwXG4gICAgfVxuXG4gICAgZ2V0VXNlckluZm8oc29ja2V0KSB7XG4gICAgICAgIC8v5L2/55Soc29ja2V0Lmlk77yM6I635Y+W55So5oi35L+h5oGvXG4gICAgfVxuXG4gICAgZ2V0VXNlcnMoc29uZ0lkKSB7XG4gICAgICAgIC8v55So5oi35oi/6Ze055qE5omA5pyJ55So5oi3XG4gICAgfVxuXG4gICAgZ2V0QWxsVXNlck1vYmlsZSgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBTZXQoKTtcbiAgICB9XG5cbiAgICBzZXRDaGF0KHNvbmdJZCwgdXNlck1vYmlsZSwgY2FuQ2hhdCkge1xuICAgICAgICAvL+iuvue9rueUqOaIt+aYr+WQpuemgeiogFxuICAgIH1cblxufVxuIl19
